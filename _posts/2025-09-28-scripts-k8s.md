---
title: 'Practice - Python Script to Kubernetes Job (1)'
date: 2025-09-28
permalink: /posts/scripts-k8s/
tags:
  - infra
---

# Objective

I am practicing for kubunetes and docker. In this case, I try to run the python DNS bruteforcer as an application on omni cluster. 

### Prepare our project for containeriztion

```
recon-onmi
├── bruteforcer.py
├── detecting_wildcard.py
├── requirements.txt
└── wordlist.txt
```

1) Prepare `requirements.txt`

```
aiodns
```

### Containerize the script with Docker

- Install Docker
- Create a Dockerfile

```
# Dockerfile

From python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

ENTRYPOINT ["python3", "bruteforcer.py"]
```

### Build the Docker image and push it to a registry

The kubernetes cluster need a place to download the container image --> Docker Hub 

1. Build the image and login to Docker Hub

```
docker build -t <your-dockerhub-username>/dns-bruteforcer:latest .
```

2. Push the image

```
docker push <your-dockerhub-username>/dns-bruteforcer:latest
```

### Create a Kubernetes Manifest to run the script

To run our script, we need to prepare yaml file for kubernetes. Our script is a task that runs once and then it will finish. Therefore, the best type of kubernetes object to use is a `Job` --> `Job` will create container `Pod`to run the script and ensure it completes successfully.

1. Create job.yaml in local machine.

```
# job.yaml

apiVersion: batch/v1
kind: Job
metadata:
	name: dns-bruteforce-job
spec:
	template:
		spec:
			containers:
			- name: dns-bruteforcer
				image: <your-dockerhub-username>/dns-bruteforcer:latest 
				args:
					- "google.com"
					- "wordlist.txt"
					- "-c"
					- "100"
			restartPolicy: OnFailure
	backoffLimit:2
```

#### Talos

Reference: https://danharr.is/posts/generating-a-kubeconfig-on-talos/

Since this project is try apply to omni, in here talos will be used. To install talosctl in the local MacBook. We can use 

```
brew install siderolabs/tap/sidero-tools
```

Then, talosctl is running. To generate talos config:

```
talosctl gen config <cluster name> <API Endpoint e.g https://<control-plane-node-ip>:6443>
```

After that, 3 config files will be generated

```
controlplane.yaml  
secrets.yaml
worker.yaml
```

I also download kubenetes config from omni (https://YOURUSERNAME.na-west-1.omni.siderolabs.io/) to call the API. For example: 

```
export KUBECONFIG=~/kubeconfigs/talos-clustername.yaml
```

Now, we can check the node status

```
kubectl get nodes
NAME                                   STATUS   ROLES           AGE     VERSION
xxx  Ready    <none>          3h35m   v1.33.3
xxx  Ready    control-plane   3h35m   v1.33.3
xxx  Ready    <none>          3h35m   v1.33.3
xxx  Ready    control-plane   3h35m   v1.33.3
xxx  Ready    <none>          3h35m   v1.33.3
xxx  Ready    control-plane   3h35m   v1.33.3
```

```
➜  ~ TALOSCTL version -n 192.168.1.238
Client:
	Tag:         v1.11.1
	SHA:         8e85c836
	Built:       
	Go version:  go1.24.6
	OS/Arch:     darwin/arm64
Server:
	NODE:        192.168.1.238
	Tag:         v1.10.6
	SHA:         cfa6c98c
	Built:       
	Go version:  go1.24.5
	OS/Arch:     linux/amd64
	Enabled:     RBAC
```

Finally, we can run `kubectl apply -f job.yaml`

---

Error `Failed to pull image "<your-dockerhub-username>/dns-bruteforcer:latest": ... no match for platform in manifest: not found`

First we need to delete job `kubectl delete job dns-bruteforce-job`

Then, rebuild it 

```
docker buildx build --platform linux/amd64 -t <your-dockerhub-username>/dns-bruteforcer:latest --push .
```

We can re-apply the job manifest again

```
kubectl apply -f job.yaml
```

Now I can get

```
kubectl get pods
NAME                       READY   STATUS      RESTARTS   AGE
dns-bruteforce-job-xcfx2   0/1     Completed   0          30s
dns-bruteforce-m77p7       0/1     Completed   0          7m5s
```

To check the result, we can use 

```
kubectl get pods
kubectl logs  <pods name e.g dns-bruteforce-job-xcfx2>
```

We can get the results:

```
➜  ~ kubectl logs  dns-bruteforce-job-xcfx2      
[+] Wildcard not detected.
[+] 123 subdomains loaded into the queue.
www.google.com                           142.250.198.228
mail.google.com                          142.250.197.197
smtp.google.com                          74.125.130.26, 74.125.68.26, 74.125.24.26, 74.125.130.27, 74.125.68.27
admin.google.com                         142.250.71.206
ns2.google.com                           216.239.34.10
ns1.google.com                           216.239.32.10
blog.google.com                          142.250.71.137
api.google.com                           142.250.76.4
vpn.google.com                           64.9.224.69, 64.9.224.68, 64.9.224.70
email.google.com                         142.250.71.174
support.google.com                       142.250.66.46
files.google.com                         142.250.71.174
help.google.com                          142.250.71.174
docs.google.com                          142.250.76.14
store.google.com                         142.250.71.238
shop.google.com                          74.125.24.92
fi.google.com                            142.250.71.174
id.google.com                            142.250.197.3
id.google.com                            142.250.197.3
```





